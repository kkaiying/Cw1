<!DOCTYPE html>
<html>
<head>
    <title>Service Point Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="/styles.css"/>
</head>

<body>
<div id="sidebar">
    <h2>Select a service point</h2>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
    const map = L.map('map').setView([55.963336127277415, -3.221583476122788], 13.4);

    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>'
    }).addTo(map);

    // Service points
    fetch('/api/cw3/mockServicePoints')
        .then(response => response.json())
        .then(points => {
            points.forEach(sp => {
                const marker = L.marker([sp.location.lat, sp.location.lng])
                    .addTo(map)
                    .bindPopup(`<b>${sp.name}</b>`);

                // Click handler
                marker.on('click', () => {
                    displayServicePointDetails(sp);
                });
            });
        })
        .catch(err => console.error(err));

    function displayServicePointDetails(sp) {
        const sidebar = document.getElementById('sidebar');

        const totalDispatches = sp.drones.reduce((sum, drone) =>
            sum + (drone.assignedDispatchesIds ? drone.assignedDispatchesIds.length : 0), 0
        );

        // Calculate workload
        const avgDispatchesPerDrone = sp.drones.length > 0 ? totalDispatches / sp.drones.length : 0;
        let workloadStatus = '';
        let workloadColor = '';

        if (avgDispatchesPerDrone < 2) {
            workloadStatus = 'Very Low - Underutilized';
            workloadColor = 'gray';
        } else if (avgDispatchesPerDrone < 5) {
            workloadStatus = 'Low - Below Capacity';
            workloadColor = 'green';
        } else if (avgDispatchesPerDrone < 8) {
            workloadStatus = 'Moderate - Optimal';
            workloadColor = 'orange';
        } else {
            workloadStatus = 'High - Overworked ⚠️';
            workloadColor = 'red';
        }

        sidebar.innerHTML = `
          <h2>${sp.name} Service Point</h2>
          <p><strong>Total drones:</strong> ${sp.drones.length}</p>
          <p><strong>Total dispatches:</strong> ${totalDispatches}</p>
          <p><strong>Avg dispatches/drone:</strong> ${avgDispatchesPerDrone.toFixed(1)}</p>
          <p style="color: ${workloadColor}; font-weight: bold;">
              <strong>Workload Status:</strong> ${workloadStatus}
          </p>
          ${avgDispatchesPerDrone >= 8 ? '<p style="color: red;">⚠️ Recommend deploying additional drones</p>' : ''}
          <h3>Drones</h3>
          <div id="drone-list"></div>
      `;

        const droneList = document.getElementById('drone-list');
        sp.drones.forEach(drone => {
            const droneDiv = document.createElement('div');
            droneDiv.className = 'drone';
            droneDiv.innerHTML = `
              <strong>- ${drone.name}</strong>
              <div class="drone-details" id="details-${drone.id}">
                  <p><strong>Status:</strong> ${drone.status}</p>
                  <p><strong>Cooling:</strong> ${drone.capability.cooling ? '✓' : '✗'}</p>
                  <p><strong>Heating:</strong> ${drone.capability.heating ? '✓' : '✗'}</p>
                  <p><strong>Capacity:</strong> ${drone.capability.capacity}</p>
                  <p><strong>Max Moves:</strong> ${drone.capability.maxMoves}</p>
                  <p><strong>Cost per Move:</strong> ${drone.capability.costPerMove}</p>
                  <p><strong>Cost Initial:</strong> ${drone.capability.costInitial}</p>
                  <p><strong>Cost Final:</strong> ${drone.capability.costFinal}</p>
                  <p><strong>Assigned Dispatches:</strong></p>
                    <ul>
                        ${drone.assignedDispatchesIds && drone.assignedDispatchesIds.length > 0
                        ? drone.assignedDispatchesIds.map(id => `<li class="dispatch-link" data-id="${id}">${id}</li>`).join('')
                            : '<li>None</li>'}
                    </ul>
              </div>
          `;

            // Click to toggle details
            droneDiv.querySelector('strong').addEventListener('click', () => {
                const details = document.getElementById(`details-${drone.id}`);
                details.style.display = details.style.display === 'block' ? 'none' : 'block';
            });

            droneList.appendChild(droneDiv);
        });

        document.querySelectorAll('.dispatch-link').forEach(link => {
            link.addEventListener('click', () => {
                const dispatchId = parseInt(link.dataset.id);

                fetch(`/api/cw3/dispatch/${dispatchId}`)
                    .then(response => response.json())
                    .then(dispatch => {
                        map.setView([dispatch.delivery.lat, dispatch.delivery.lng], 16);
                    })
                    .catch(err => console.error(err));
            });
        });
    }

    // Restricted areas
    // fetch('/api/cw3/mockRestrictedAreas')
    //     .then(response => response.json())
    //     .then(areas => {
    //         areas.forEach(area => {
    //             const coords = area.vertices.map(v => [v.lat, v.lng]);
    //             L.polygon(coords, {
    //                 color: 'red',
    //                 fillColor: '#f03',
    //                 fillOpacity: 0.3
    //             }).addTo(map).bindPopup(`<b>${area.name}</b>`);
    //         });
    //     });

    // Heatmap for dispatches
    fetch('/api/cw3/mockDispatches')
        .then(response => response.json())
        .then(dispatches => {
            // Heatmap layer
            const heatData = dispatches.map(d => [d.delivery.lat, d.delivery.lng, 0.5]);
            L.heatLayer(heatData, {
                radius: 35,        // Increase from 25 to make it wider
                blur: 25,          // Increase blur for smoother gradient
                maxZoom: 17,
                max: 0.5,          // Add this - lower max intensity shows more colors
                gradient: {
                    0.0: 'blue',
                    0.2: 'cyan',
                    0.4: 'lime',
                    0.6: 'yellow',
                    0.8: 'orange',
                    1.0: 'red'
                }
            }).addTo(map);

            // Individual dots
            dispatches.forEach(dispatch => {
                L.circleMarker([dispatch.delivery.lat, dispatch.delivery.lng], {
                    radius: 1.5,
                    color: '#bc0505',
                    fillColor: '#bc0505',
                    fillOpacity: 1,
                    weight: 0.5
                })
                    .bindPopup(`
                  <b>Dispatch #${dispatch.id}</b><br>
                  Cooling: ${dispatch.cooling ? '✓' : '✗'}<br>
                  Heating: ${dispatch.heating ? '✓' : '✗'}<br>
                  Capacity: ${dispatch.capacity}<br>
                  Assigned to: ${dispatch.assignedDroneId || 'Not assigned'}`)
                    .addTo(map);
            });
        })
        .catch(err => console.error(err));

</script>
</body>
</html>